<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Meal</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>Add a Meal</h1>
    <form id="mealForm">
        <!-- User selection dropdown -->
        <label for="user">MyUser:</label>
        <select id="user" name="user" required>
            <!-- Options will be populated dynamically -->
        </select>
        <br><br>

        <!-- Date input -->
        <label for="date">Date:</label>
        <input type="date" id="date" name="date" required>
        <br><br>

        <!-- Time input -->
        <label for="time">Time:</label>
        <input type="time" id="time" name="time" required>
        <br><br>

        <!-- Food selection -->
        <label for="foods">Select Foods:</label>
        <select id="foods" name="foods" multiple required>
            <!-- Options will be populated dynamically -->
        </select>
        <br><br>

        <button type="submit" id="add_meal">Add Meal</button>
        <button type="button" id="backButton">Back</button>
    </form>

    <script>
    function isTokenExpired(token) {
    if (!token) return true;
    const payload = JSON.parse(atob(token.split('.')[1]));  // Decode JWT payload
    const currentTime = Math.floor(Date.now() / 1000);      // Current time in seconds
    return payload.exp < currentTime;                       // True if expired
}
    async function refreshToken() {
        const refresh_token = localStorage.getItem('refresh_token');
        
        return axios.post('http://127.0.0.1:8000/api/token/refresh/', { refresh: refresh_token })
            .then(response => {
                // Update the access token in localStorage
                localStorage.setItem('access_token', response.data.access);
                return response.data.access;
            })
            .catch(error => {
                console.error("Error refreshing token:", error);
                // If the refresh token has expired, redirect to login
                window.location.href = "http://127.0.0.1:5500/frontend/login.html";
            });
    }
    
    // Function to handle token expiration
    async function handleTokenExpiration() {
        try {
            const newToken = await refreshToken();  // Refresh token and update local storage
            axios.defaults.headers.common['Authorization'] = `Bearer ${newToken}`;  // Update default Authorization header
        } catch (error) {
            console.error("Failed to refresh token:", error);
            // Redirect to login page if token refresh fails
            window.location.href = "http://127.0.0.1:5500/frontend/login.html";
        }
     
    //  try {
    // // Attempt to submit the form
    //     await axios.post('http://127.0.0.1:8000/api/add_meals/', mealData, {
    //         headers: { 'Authorization': `Bearer ${token}` }
    // });
    // } catch (error) {
    //     if (error.response && error.response.status === 401) {
    //         try {
    //             // Token might be expired, try refreshing it
    //             const newToken = await handleTokenExpiration();

    //             // Retry the request with the refreshed token
    //             await axios.post('http://127.0.0.1:8000/api/add_meals/', mealData, {
    //                 headers: { 'Authorization': `Bearer ${newToken}` }
    //             });
    //         } catch (refreshError) {
    //             console.error("Failed to refresh token:", refreshError);

    //             // Redirect to login page if token refresh fails
    //             window.location.href = "http://127.0.0.1:5500/frontend/login.html";
    //         }
    //     } else {
    //         console.error("Error adding meal:", error);
    //         alert("Failed to add meal.");
    //     }
    // }
    }
    // Function to populate user and food options
//     async function populateOptions() {
//         // Check if token exists and is valid
//     // if (!token || isTokenExpired(token)) {
//     //     console.log("Token is missing or expired. Redirecting to login.");
//     //     window.location.href = "http://127.0.0.1:5500/frontend/login.html";
//     //     return;  // Stop function execution if token is invalid
//     // }    
//         try {
//             const token = localStorage.getItem('access_token');
            
//             // Fetch users with Authorization header
//             const usersResponse = await axios.get('http://127.0.0.1:8000/api/users/', {
//                 headers: { 'Authorization': `Bearer ${token}` }
//             });
            
//             const userSelect = document.getElementById('user');
//             usersResponse.data.forEach(user => {
//                 const option = document.createElement('option');
//                 option.value = user.id;
//                 option.textContent = user.username;
//                 userSelect.appendChild(option);
//             });

//             // Fetch foods with Authorization header
//             const foodsResponse = await axios.get('http://127.0.0.1:8000/api/foods/', {
//                 headers: { 'Authorization': `Bearer ${token}` }
//             });
            
//             const foodsSelect = document.getElementById('foods');
//             foodsResponse.data.forEach(food => {
//                 const option = document.createElement('option');
//                 option.value = food.id;
//                 option.textContent = food.name;
//                 foodsSelect.appendChild(option);
//             });
//         } catch (error) {
//             if (error.response && error.response.status === 401) {
//                 console.log(error.response.status);
//                 // Token might be expired, try refreshing it
//                 await handleTokenExpiration();
//                 populateOptions();  // Retry after refreshing token
//             } else {
//                 console.error('Error loading options:', error);
//             }
//         }
//     }

//         // Call the function to populate options on page load
//         window.onload = populateOptions;

//         // Form submit handler
//         document.getElementById('mealForm').addEventListener('submit', async function(event) {
//             event.preventDefault();  // Prevent form from reloading the page
                
//         // Get values from the form
//         const user=parseInt(document.getElementById('user').value, 10);  // Convert user ID to an integer          // Ensure user ID is an integer
//         const date = document.getElementById('date').value;                    // Date in YYYY-MM-DD format
//         const time = document.getElementById('time').value;                    // Time in HH:MM format
//         // Convert food_info to an array of integers
//         // const food_info = Array.from(document.getElementById('foods').selectedOptions).map(option => parseInt(option.value));
//         const food_info =Array.from(document.getElementById('foods').selectedOptions).map(option => parseInt(option.value, 10))  // Convert each food ID to an integer in base 10.
//         // Debugging: Log each part of mealData to confirm data types
//         console.log("User ID:", user);
//         console.log("Date:", date);
//         console.log("Time:", time);
//         console.log("Food Info (should be integers):", food_info);

//         // Prepare the mealData object
//         const mealData = { user, date, time, food_info };

//         // console.log("Meal Data:", mealData);  // Verify final mealData structure
//         console.log("Meal Data:", JSON.stringify(mealData));  // Verify the JSON structure of mealData

//         const token = localStorage.getItem('access_token');
        
      
//         // const user = document.getElementById('user').value;
//         // const date = document.getElementById('date').value;
//         // const time = document.getElementById('time').value;
//         // const foods = Array.from(document.getElementById('foods').selectedOptions).map(option => option.value);

//         try {
//             // Send POST request to add meal with Authorization header
//             await axios.post('http://127.0.0.1:8000/add_meals/', mealData, {
//                 headers: { 'Authorization': `Bearer ${token}`,
//                 'Content-Type': 'application/json'
//             }  
//             });// Explicitly set the content type to JSON
//             console.log("Meal Data:", mealData);  // Debugging: Verify mealData structure
//             alert('Meal added successfully!');
//             console.log('Meal added successfully!');
//         } catch (error) {
//             if (error.response && error.response.status === 401) {
//                 // Token might be expired, try refreshing it
//                 await handleTokenExpiration();
//                 document.getElementById('mealForm').dispatchEvent(new Event('submit'));  // Retry after refreshing token
//             } else {
//                 console.error("Error adding meal:", error.response ? error.response.data : error.message);
//                 console.log('Failed to add meal');
//             }
//         }
//     });

//     document.getElementById('backButton').addEventListener('click', function() {
//         window.location.href = 'http://127.0.0.1:5500/frontend/daily_meals.html';
//     }); 
        
        
//         // function to populate user and food options
//         async function populateOptions() {
//             // Check if token is expired
//             const token = localStorage.getItem('access_token');
//             if (!token || isTokenExpired(token)) {
//                 await handleTokenExpiration();  // Refresh token if expired
//             }
//             try {
//                 // Fetch users
//                 const usersResponse = await axios.get('http://127.0.0.1:8000/api/users/');
//                 const userSelect = document.getElementById('user');
//                 usersResponse.data.forEach(user => {
//                     const option = document.createElement('option');
//                     option.value = user.id;
//                     option.textContent = user.username;  // Use 'username' instead of 'name'
//                     userSelect.appendChild(option);
//                 });

//                 // Fetch foods
//                 // console.log()
//                 const foodsResponse = await axios.get('http://127.0.0.1:8000/api/foods/');  // Endpoint for fetching foods - ceate one
//                 console.log("Foods data:", foodsResponse.data);  // Process response data here
//                 const foodsSelect = document.getElementById('foods');
//                 foodsResponse.data.forEach(food => {
//                     const option = document.createElement('option');
//                     option.value = food.id;
//                     option.textContent = food.name;
//                     foodsSelect.appendChild(option);
//                 });
//             } catch (error) {
//                 console.error('Error loading options:', error);
//             }
//         }

//         // Call the function to populate options on page load
//         window.onload = populateOptions;

//         // Form submit handler
//         document.getElementById('mealForm').addEventListener('submit', async function(event) {
//             event.preventDefault();  // Prevent form from reloading page

//             // Get values from the form
//             const user = document.getElementById('user').value;
//             const date = document.getElementById('date').value;
//             const time = document.getElementById('time').value;
//             const foods = Array.from(document.getElementById('foods').selectedOptions).map(option => option.value);

//             // Create meal data object
//             const mealData = {
//                 user,
//                 date,
//                 time,
//                 food_info: foods
//             };
//             console.log(mealData.date);
//             console.log(mealData.user);
//             console.log(mealData.time);
//             console.log(mealData.food_info);
//             try {
//                 // Send POST request to add meal
//                 const response = await axios.post('http://127.0.0.1:8000/api/add_meals/', mealData);
//                 console.log('Meal added successfully!');
//             } catch (error) {
//                 console.error('Error adding meal:', error);
//                 alert('Failed to add meal');
//             }
//         });
//         document.getElementById('backButton').addEventListener('click', function() {
//     window.location.href = 'http://127.0.0.1:5500/frontend/daily_meals.html';
// });
async function handleTokenExpiration() {
        try {
            const newToken = await refreshToken();
            axios.defaults.headers.common['Authorization'] = `Bearer ${newToken}`;
        } catch (error) {
            console.error("Failed to refresh token:", error);
            window.location.href = "http://127.0.0.1:5500/frontend/login.html";
        }
    }
    // function to populate user and food options
    async function populateOptions() {
        const token = localStorage.getItem('access_token');
        if (!token || isTokenExpired(token)) {
            await handleTokenExpiration();
        }
        try {
             // Fetch users
                const usersResponse = await axios.get('http://127.0.0.1:8000/api/users/');
                const userSelect = document.getElementById('user');
                usersResponse.data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.username;  // Use 'username' instead of 'name'
                    userSelect.appendChild(option);
            });

            const foodsResponse = await axios.get('http://127.0.0.1:8000/api/foods/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const foodsSelect = document.getElementById('foods');
            foodsResponse.data.forEach(food => {
                const option = document.createElement('option');
                option.value = food.id;
                option.textContent = food.name;
                foodsSelect.appendChild(option);
            });
        } catch (error) {
            if (error.response && error.response.status === 401) {
                await handleTokenExpiration();
                populateOptions();
            } else {
                console.error('Error loading options:', error);
            }
        }
    }

    window.onload = populateOptions;

    document.getElementById('mealForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const user = parseInt(document.getElementById('user').value, 10);
        const date = document.getElementById('date').value;
        const time = document.getElementById('time').value;
        const food_info = Array.from(document.getElementById('foods').selectedOptions).map(option => parseInt(option.value, 10));

        const mealData = { user, date, time, food_info };
        const token = localStorage.getItem('access_token');
        
        try {
            await axios.post('http://127.0.0.1:8000/api/add_meals/', mealData, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            alert('Meal added successfully!');
        } catch (error) {
            if (error.response && error.response.status === 401) {
                await handleTokenExpiration();
                document.getElementById('mealForm').dispatchEvent(new Event('submit'));
            } else {
                console.error("Error adding meal:", error.response ? error.response.data : error.message);
                alert("Failed to add meal.");
            }
        }
    });

    document.getElementById('backButton').addEventListener('click', function() {
        window.location.href = 'http://127.0.0.1:5500/frontend/daily_meals.html';
    });

    </script>
</body>
</html>
